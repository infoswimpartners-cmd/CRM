# システム操作・仕様マニュアル

## 1. レッスンスケジュール・請求システム

### 1-1. 請求・課金の仕組み
本システムでは、レッスンの予約状況と会員プランに基づいて、以下のロジックで自動的に請求処理を行います。

#### A. 課金対象となるケース
1. **単発会員（ビジター）の予約**
   - 常に課金対象となります。
2. **月謝会員の回数超過（追加レッスン）**
   - 月の規定回数（例: 月4回）を超えて5回目以降のレッスンを登録した場合、自動的に「実費（追加レッスン料）」として扱われます。
   - 画面上には `利用状況: 4 / 4 回` のように現在の消化数が表示されます。

#### B. 請求金額の算出
- **優先ルール**: 選択された「レッスン種別」に設定されている単価（例: 60分 9,000円, 90分 13,000円）が優先して適用されます。
- **フォールバック**: レッスン種別に単価設定がない場合のみ、会員費からの割り戻し計算（またはデフォルト8,800円）が適用されます。

#### C. 自動処理のタイムライン
登録されたレッスン日時から逆算して、以下のスケジュールで自動処理が予約されます。
（※直前予約の場合は即時実行されます）

| タイミング | アクション | 内容 |
| :--- | :--- | :--- |
| **登録時** | スケジュール作成 | 請求ステータスは `pending` または `future_billing` として保存されます。 |
| **2日前の 12:00** | 予告メール送信 | 「【重要】レッスン料のご請求予定のお知らせ」メールが生徒に送信されます。 |
| **1日前の 12:00** | 請求確定 (Stripe) | StripeにてInvoiceItem（請求書項目）が作成され、実際の決済予約が行われます。 |

---

## 2. 管理画面（ダッシュボード）の機能

### 2-1. スケジュール登録画面
「予定を追加」ボタンから開くダイアログの機能詳細です。

- **時間選択**:
  - 「時」と「分」それぞれ独立したプルダウンで選択可能です（分は5分刻み）。
- **生徒情報の自動表示**:
  - 生徒を選択すると、現在の「会員種別」および「今月の利用状況（消化回数 / 上限）」が表示されます。
- **レッスン種別の自動選択**:
  - 生徒の会員情報に基づき、デフォルトのレッスン種別（例: 月4回 60分）が自動的に選択されます。
  - リストが1つしかない場合も自動選択されます。

### 2-2. 登録完了時の挙動
- **Googleカレンダー連携**:
  - 登録に成功すると、「Googleカレンダーに追加」ボタンが表示された完了画面になります。
  - この画面は「閉じる」を押すまで表示され続けるため、カレンダー登録作業をゆっくり行えます。

### 2-3. 通知メッセージ
画面右上に表示されるポップアップ（トースト）には以下の意味があります。

| メッセージ種別 | 文言例 | 意味 |
| :--- | :--- | :--- |
| **通常** | スケジュールを追加しました | 請求の発生しない、通常の月謝内レッスンとして登録されました。 |
| **単発/請求あり** | レッスンを追加し、レッスン料の請求処理予約を行いました。 | 単発会員のレッスンとして登録され、後日請求が行われます。 |
| **回数超過** | 月の上限回数を超えているため、超過分（単発）として登録されました。 | 月謝枠を使い切っているため、追加料金が発生するレッスンとして登録されました。 |
