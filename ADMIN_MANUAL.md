# 管理者マニュアル

## 1. レッスンスケジュール・請求システム

### 1-1. 請求・課金の仕組み
本システムでは、レッスンの予約状況と会員プランに基づいて、以下のロジックで自動的に請求処理を行います。

#### A. 課金対象となるケース
1. **単発会員（ビジター）の予約**
   - 常に課金対象となります。
2. **月謝会員の回数超過（追加レッスン）**
   - 月の規定回数（例: 月4回）を超えて5回目以降のレッスンを登録した場合、自動的に「実費（追加レッスン料）」として扱われます。
   - 画面上には `利用状況: 4 / 4 回` のように現在の消化数が表示されます。

#### B. 請求金額の算出
- **優先ルール**: 選択された「レッスン種別」に設定されている単価（例: 60分 9,000円, 90分 13,000円）が優先して適用されます。
- **フォールバック**: レッスン種別に単価設定がない場合のみ、会員費からの割り戻し計算（またはデフォルト8,800円）が適用されます。

#### C. 自動処理のタイムライン
登録されたレッスン日時から逆算して、以下のスケジュールで自動処理が予約されます。
（※直前予約の場合は即時実行されます）

| タイミング | アクション | 内容 |
| :--- | :--- | :--- |
| **登録時** | スケジュール作成 | 請求ステータスは `pending` または `future_billing` として保存されます。 |
| **2日前の 12:00** | 予告メール送信 | 「【重要】レッスン料のご請求予定のお知らせ」メールが生徒に送信されます。 |
| **1日前の 12:00** | 請求確定 (Stripe) | StripeにてInvoiceItem（請求書項目）が作成され、実際の決済予約が行われます。 |

---

## 2. 管理画面（ダッシュボード）の機能

### 2-1. スケジュール登録画面
「予定を追加」ボタンから開くダイアログの機能詳細です。

- **時間選択**:
  - 「時」と「分」それぞれ独立したプルダウンで選択可能です（分は5分刻み）。
- **生徒情報の自動表示**:
  - 生徒を選択すると、現在の「会員種別」および「今月の利用状況（消化回数 / 上限）」が表示されます。
- **レッスン種別の自動選択**:
  - 生徒の会員情報に基づき、デフォルトのレッスン種別（例: 月4回 60分）が自動的に選択されます。
  - リストが1つしかない場合も自動選択されます。

### 2-2. 登録完了時の挙動
- **Googleカレンダー連携**:
  - 登録に成功すると、「Googleカレンダーに追加」ボタンが表示された完了画面になります。
  - この画面は「閉じる」を押すまで表示され続けるため、カレンダー登録作業をゆっくり行えます。

### 2-3. 通知メッセージ
画面右上に表示されるポップアップ（トースト）には以下の意味があります。

| メッセージ種別 | 文言例 | 意味 |
| :--- | :--- | :--- |
| **通常** | スケジュールを追加しました | 請求の発生しない、通常の月謝内レッスンとして登録されました。 |
| **回数超過** | 月の上限回数を超えているため、超過分（単発）として登録されました。 | 月謝枠を使い切っているため、追加料金が発生するレッスンとして登録されました。 |

---

## 3. コーチ管理・アカウント発行

### 3-1. コーチの招待（アカウント作成）
従来の「パスワード通知」方式は廃止され、セキュリティの高い「招待リンク」方式に変更されました。

1. **管理者による招待**:
   - 管理画面の「コーチ管理」→「コーチを追加」ボタンを押します。
   - 氏名とメールアドレスを入力して送信します（この時点ではパスワードは設定しません）。
   - ステータスは「招待中（Pending）」となり、一覧には薄い黄色で表示されます。

2. **招待メールの受信**:
   - コーチ宛にシステムから「アカウント招待のお知らせ」メールが届きます。
   - メール内のURL（有効期限24時間）をクリックします。

3. **パスワード設定**:
   - 専用のパスワード設定画面が開きます。
   - コーチ自身が任意のパスワード（8文字以上）を設定します。
   - 完了すると自動的にアカウントが有効化（Active）され、ログイン画面へ移動します。

### 3-2. 再招待・リンク切れ対応
- 招待リンクの有効期限（24時間）が切れた場合、コーチは登録を完了できません。
- 管理者はコーチ一覧の「招待中」ステータス横にある「再招待ボタン（紙飛行機アイコン）」をクリックすることで、新しいリンクを発行・再送できます。
- また、「リンクコピーボタン（鎖アイコン）」をクリックすると、招待URLをクリップボードにコピーできます。チャットツールなどで直接送付する場合にご利用ください。
- 既に登録済みのコーチ（Active）には再招待は送れません（本人による「パスワードをお忘れですか？」機能を利用してください）。

